<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è¶…ç´šèœœèœ‚é€²åŒ–è«–ï¼šç²¾ç¢ºé›£åº¦ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Varela+Round&display=swap" rel="stylesheet">
    <style>
        /* --- åŸºç¤è¨­å®š --- */
        * { box-sizing: border-box; }
        body, html {
            margin: 0; padding: 0;
            width: 100%; height: 100%;
            overflow: hidden;
            background-color: #fdfdf5;
            font-family: 'Varela Round', sans-serif;
            touch-action: none;
            -webkit-user-select: none;
            user-select: none;
            transition: background-color 2s;
        }

        #game-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; z-index: 1; }
        canvas { display: block; width: 100%; height: 100%; }

        /* ç‰¹æ•ˆå±¤ */
        #damage-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 0, 0, 0.4); pointer-events: none; z-index: 5; opacity: 0; transition: opacity 0.1s; }
        #flash-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: white; pointer-events: none; z-index: 20; opacity: 0; transition: opacity 3s ease-in; }

        /* UI å±¤ */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; display: flex; flex-direction: column; justify-content: space-between; padding: 16px; }

        /* å…¨è¢å¹•è¦†è“‹å±¤ */
        .overlay-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #fdfdf5; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s; }
        .hidden { display: none !important; }

        /* æŒ‰éˆ•æ¨£å¼ */
        .nook-btn {
            color: white; font-size: 1.2rem; padding: 12px 20px;
            border-radius: 99px; border: none; cursor: pointer; font-weight: bold;
            pointer-events: auto; touch-action: manipulation; transition: transform 0.1s;
            width: 100%; max-width: 300px; text-align: center; position: relative; z-index: 10001;
            margin-bottom: 10px; box-shadow: 0 4px 0 rgba(0,0,0,0.2);
        }
        .nook-btn:active { transform: translateY(4px); box-shadow: none !important; }
        
        /* é›£åº¦æŒ‰éˆ•çµ„ */
        .diff-group { display: flex; gap: 8px; margin-bottom: 20px; width: 100%; max-width: 320px; }
        .diff-btn {
            flex: 1; padding: 10px 0; border-radius: 15px; border: none;
            color: white; font-weight: bold; font-size: 1rem; cursor: pointer;
            transition: all 0.2s; pointer-events: auto; touch-action: manipulation;
            opacity: 0.6; transform: scale(0.95);
        }
        .diff-btn.active { opacity: 1; transform: scale(1.05); box-shadow: 0 4px 0 rgba(0,0,0,0.2); z-index: 10; }
        
        .btn-easy { background-color: #8bd6b8; } 
        .btn-hard { background-color: #f39c12; } 
        .btn-nightmare { background-color: #c0392b; }

        .btn-space { background-color: #6c5ce7; box-shadow: 0 5px 0 #4834d4; }
        .btn-earth { background-color: #27ae60; box-shadow: 0 5px 0 #1e8449; }
        .btn-home { background-color: #95a5a6; box-shadow: 0 5px 0 #7f8c8d; }

        /* UI å…ƒä»¶ */
        .nook-badge { background: rgba(255, 255, 255, 0.95); border: 4px solid #8bd6b8; border-radius: 30px; padding: 8px 16px; color: #7c6b5d; font-weight: bold; display: flex; align-items: center; gap: 10px; font-size: 14px; box-shadow: 0 4px 0 rgba(0,0,0,0.05); }
        .progress-bar-bg { width: 100px; height: 12px; background: #e6dcc5; border-radius: 6px; overflow: hidden; }
        .progress-bar-fill { height: 100%; width: 0%; background: #f2a84e; transition: width 0.3s; }
        
        .timer-badge { background: #fff; border: 4px solid #ff6b6b; color: #ff6b6b; font-size: 1.5rem; min-width: 100px; justify-content: center; font-variant-numeric: tabular-nums; }
        .timer-emergency { animation: pulse-scale 0.5s infinite; background: #ffeaea; }
        @keyframes pulse-scale { 0%{transform:scale(1);} 50%{transform:scale(1.1);} 100%{transform:scale(1);} }

        #diff-label { position: absolute; top: 16px; right: 16px; font-size: 0.8rem; color: #fff; padding: 4px 12px; border-radius: 20px; font-weight: bold; opacity: 0.8; pointer-events: none; }
    </style>
</head>
<body>

    <!-- 1. é¦–é  -->
    <div id="start-screen" class="overlay-screen">
        <div class="text-center p-4 max-w-sm w-full">
            <h1 class="text-4xl text-[#68513d] font-bold mb-2">è¶…ç´šèœœèœ‚</h1>
            <h2 class="text-2xl text-[#ff6b6b] font-bold mb-6">é€²åŒ–è«–</h2>
            
            <div class="bg-white p-5 rounded-3xl border-4 border-[#e6dcc5] mb-6 text-[#7c6b5d] shadow-sm">
                <p class="font-bold text-center text-lg mb-3">1. é¸æ“‡é›£åº¦</p>
                <div class="diff-group">
                    <button id="btn-diff-easy" onclick="setDiff('easy')" class="diff-btn btn-easy active">ç°¡å–®</button>
                    <button id="btn-diff-hard" onclick="setDiff('hard')" class="diff-btn btn-hard">å›°é›£</button>
                    <button id="btn-diff-nightmare" onclick="setDiff('nightmare')" class="diff-btn btn-nightmare">æƒ¡å¤¢</button>
                </div>
                <div id="diff-desc" class="text-xs text-center text-gray-500 h-8 leading-tight">
                    æ™‚é–“å……è£•ï¼Œæˆé•·æ¨™æº–ã€‚
                </div>
            </div>

            <div class="flex flex-col gap-2 w-full items-center">
                <p class="text-[#7c6b5d] font-bold mb-1">2. é¸æ“‡é—œå¡å‡ºç™¼</p>
                <button onclick="startLevel(1)" class="nook-btn btn-earth">ğŸŒ åœ°çƒ (Earth)</button>
                <button onclick="startLevel(2)" class="nook-btn btn-space">ğŸš€ å¤ªç©º (Space)</button>
            </div>
        </div>
    </div>

    <!-- 2. ç¬¬ä¸€é—œ é€šé—œ -->
    <div id="level-clear-screen" class="overlay-screen hidden">
        <h1 class="text-5xl text-[#f2a84e] font-bold mb-4">åœ°çƒåˆ¶éœ¸ï¼</h1>
        <div class="text-8xl mb-6">ğŸŒğŸ‘‘</div>
        <p class="text-[#7c6b5d] font-bold mb-8">ä½ å·²ç¶“å¾æœäº†é€™é¡†æ˜Ÿçƒã€‚</p>
        <div class="flex flex-col gap-4 w-full max-w-xs items-center">
            <button onclick="startLevel(2)" class="nook-btn btn-space">ğŸš€ é£›å‘å®‡å®™ (ç¬¬2é—œ)</button>
            <button onclick="startLevel(1)" class="nook-btn btn-earth">â†º å†æŒ‘æˆ°ä¸€æ¬¡åœ°çƒ</button>
            <button onclick="goHome()" class="nook-btn btn-home">ğŸ  å›åˆ°é¦–é </button>
        </div>
    </div>

    <!-- 3. ç¬¬äºŒé—œ ä»‹ç´¹ -->
    <div id="level2-intro-screen" class="overlay-screen hidden" style="background-color: #0b0b15; color: white;">
        <h1 class="text-4xl text-yellow-300 font-bold mb-2">ç¬¬ 2 é—œï¼šå¤ªé™½ç³»</h1>
        <div class="text-6xl mb-6 animate-bounce">ğŸ‘¨â€ğŸš€</div>
        <div class="bg-gray-800 p-6 rounded-3xl border-4 border-yellow-500 mb-6 text-left text-sm space-y-3 max-w-xs">
            <p>â³ <b>æ™‚é™ï¼š</b> <span id="l2-time-display">120</span>ç§’ã€‚</p>
            <p>âš ï¸ <b>æ³¨æ„ï¼š</b> å¿…é ˆé•·å¤§æ‰èƒ½åƒä¸‹ä¸€éšæ˜Ÿçƒï¼</p>
            <p>â˜€ï¸ <b>çµ‚å±€ï¼š</b> æ»¿ç´šå¾Œæ’é€²å¤ªé™½ã€‚</p>
        </div>
        <button onclick="startLevel(2)" class="nook-btn btn-space">ç™¼å°„å‡ç©º</button>
    </div>

    <!-- 4. å¤±æ•— -->
    <div id="game-over-screen" class="overlay-screen hidden">
        <h1 class="text-5xl text-[#ff6b6b] font-bold mb-4">ä»»å‹™å¤±æ•—</h1>
        <div class="text-8xl mb-6">â˜ ï¸</div>
        <p id="fail-reason" class="text-[#7c6b5d] font-bold mb-8">...</p>
        <div class="flex flex-col gap-4 w-full max-w-xs items-center">
            <button onclick="retryLevel()" class="nook-btn btn-earth">å†è©¦ä¸€æ¬¡æœ¬é—œ</button>
            <button onclick="goHome()" class="nook-btn btn-home">ğŸ  å›åˆ°é¦–é </button>
        </div>
    </div>

    <!-- 5. å‹åˆ© -->
    <div id="victory-screen" class="overlay-screen hidden" style="background: black; color: white;">
        <div class="relative z-10 text-center p-8 border-4 border-yellow-500 rounded-3xl bg-gray-900/90 backdrop-blur-md max-w-md shadow-[0_0_50px_rgba(255,200,0,0.5)]">
            <h1 class="text-5xl text-yellow-400 font-bold mb-4">å®‡å®™æ–°æ†æ˜Ÿ</h1>
            <div class="text-8xl my-6 animate-pulse">â˜€ï¸ğŸ</div>
            <p class="text-xl text-gray-300 mb-2 font-bold">éŠæˆ²é€šé—œ</p>
            <p class="text-sm text-gray-400 mb-8">ä½ èˆ‡å¤ªé™½èç‚ºä¸€é«”ï¼Œç…§äº®äº†éŠ€æ²³ç³»ã€‚</p>
            <button onclick="goHome()" class="nook-btn btn-space">ğŸ  å›åˆ°é¦–é é‡æ–°é–‹å§‹</button>
        </div>
        <div class="absolute inset-0 z-0 overflow-hidden">
            <div class="absolute top-1/2 left-1/2 w-[800px] h-[800px] bg-yellow-500/20 rounded-full blur-3xl transform -translate-x-1/2 -translate-y-1/2 animate-pulse"></div>
        </div>
    </div>

    <!-- éŠæˆ²å±¤ -->
    <div id="game-container">
        <canvas id="gameCanvas"></canvas>
        <div id="damage-overlay"></div>
        <div id="flash-overlay"></div>
        <div id="diff-label">ç°¡å–®</div>
        
        <div id="ui-layer">
            <div class="flex justify-between w-full items-start">
                <div class="flex flex-col gap-2">
                    <div class="nook-badge">
                        <span id="ui-stage">å¹¼å¹´æœŸ</span>
                        <div class="progress-bar-bg"><div id="ui-bar" class="progress-bar-fill"></div></div>
                    </div>
                    <div class="nook-badge" style="border-color: #f2a84e;">
                        <span id="ui-size">1.0m</span>
                    </div>
                </div>
                <div id="timer-box" class="nook-badge timer-badge"><span id="ui-timer">00:00</span></div>
            </div>
            
            <div class="w-full text-center pointer-events-none mt-auto mb-8">
                <div id="hint-box" class="inline-block bg-white/90 px-6 py-3 rounded-full border-4 border-[#e6dcc5] shadow-lg transition-all">
                    <span id="ui-hint" class="text-[#68513d] font-bold text-lg">ç›®æ¨™ï¼š...</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // =============================================
        // 1. å…¨åŸŸè®Šæ•¸èˆ‡è¨­å®š (æ•¸å€¼æ›´æ–°)
        // =============================================
        const DIFFICULTY = {
            'easy': { 
                name: 'ç°¡å–®', color: '#8bd6b8', 
                desc: 'è¼•é¬†é«”é©—ã€‚\n120ç§’ / å±éšª 20%\næ’åˆ°ç¸®å° 10%',
                timeL1: 120, timeL2: 120, // ä¿®æ­£ç‚º 120
                dangerProb: 0.2, growthRate: 0.33, penalty: 0.9,
                bossHitBox: 1.05 
            },
            'hard': { 
                name: 'å›°é›£', color: '#f39c12', 
                desc: 'é€²éšæŒ‘æˆ°ã€‚\n120ç§’ / å±éšª 25%\næ’åˆ°ç¸®å° 15%',
                timeL1: 120, timeL2: 120, // ä¿®æ­£ç‚º 120
                dangerProb: 0.25, growthRate: 0.26, // 80% of 0.33
                penalty: 0.85, 
                bossHitBox: 0.95 
            },
            'nightmare': { 
                name: 'æƒ¡å¤¢', color: '#c0392b', 
                desc: 'æ¥µé™æ“ä½œã€‚\n120ç§’ / å±éšª 25%\næ’åˆ°ç¸®å° 15%',
                timeL1: 120, timeL2: 120, // ä¿®æ­£ç‚º 120
                dangerProb: 0.25, growthRate: 0.28, // 85% of 0.33
                penalty: 0.85, // ä¿®æ­£ç‚º 15%
                bossHitBox: 0.85 
            }
        };

        // é—œå¡è³‡æ–™ (åš´æ ¼åˆ†éš)
        const LEVEL_1_DATA = [
            { name: "å¹¼å¹´æœŸ", min: 20, grid: 60, objs: [{t:"ğŸŒ¸",s:12,v:5}, {t:"ğŸ¬",s:14,v:6}, {t:"ğŸ€",s:10,v:4}, {t:"ğŸ“",s:16,v:7}, {t:"ğŸª",s:18,v:5}] },
            { name: "æˆé•·æœŸ", min: 60, grid: 120, objs: [{t:"ğŸ",s:50,v:15}, {t:"ğŸ”",s:55,v:20}, {t:"ğŸ„",s:45,v:12}, {t:"ğŸ•",s:58,v:22}, {t:"ğŸ€",s:65,v:25}] },
            { name: "å·¨å¤§æœŸ", min: 200, grid: 300, objs: [{t:"ğŸŒ³",s:140,v:50}, {t:"ğŸš—",s:160,v:60}, {t:"ğŸ•",s:120,v:40}, {t:"ğŸš²",s:130,v:45}, {t:"â›º",s:180,v:55}] },
            { name: "æ€ªç¸æœŸ", min: 600, grid: 800, objs: [{t:"ğŸ ",s:400,v:150}, {t:"ğŸ¢",s:550,v:200}, {t:"ğŸ¦–",s:450,v:180}, {t:"ğŸš¢",s:500,v:190}, {t:"ğŸŸï¸",s:520,v:220}] },
            { name: "åœ°çƒç´š", min: 1500, grid: 2000, objs: [{t:"âœˆï¸",s:800,v:400}, {t:"â›°ï¸",s:1200,v:800}, {t:"ğŸŒ‹",s:1000,v:600}, {t:"ğŸï¸",s:1100,v:700}, {t:"ğŸ—½",s:700,v:300}] }
        ];

        const LEVEL_2_DATA = [
            { name: "è¿‘åœ°è»Œé“", min: 60, grid: 120, objs: [{t:"ğŸ›°ï¸",s:30,v:10,n:"è¡›æ˜Ÿ"}, {t:"ğŸš€",s:40,v:15,n:"ç«ç®­"}, {t:"ğŸ“¡",s:35,v:12,n:"æ¢æ¸¬"}, {t:"ğŸ”­",s:45,v:18,n:"å“ˆä¼¯"}, {t:"ğŸ—‘ï¸",s:28,v:8,n:"åƒåœ¾"}] },
            { name: "å°è¡Œæ˜Ÿå¸¶", min: 200, grid: 300, objs: [{t:"â˜„ï¸",s:80,v:30,n:"å½—æ˜Ÿ"}, {t:"ğŸŒ‘",s:120,v:50,n:"å°æœˆçƒ"}, {t:"ğŸª¨",s:70,v:25,n:"éš•çŸ³"}, {t:"ğŸ›¸",s:100,v:35,n:"UFO"}, {t:"ğŸ’",s:90,v:45,n:"æ™¶é«”"}] },
            { name: "å²©çŸ³è¡Œæ˜Ÿ", min: 800, grid: 800, objs: [{t:"âšª",s:250,v:100,n:"æ°´æ˜Ÿ"}, {t:"ğŸ”´",s:300,v:120,n:"ç«æ˜Ÿ"}, {t:"ğŸŸ¢",s:350,v:150,n:"é‡‘æ˜Ÿ"}, {t:"ğŸ”µ",s:380,v:160,n:"åœ°çƒ"}, {t:"ğŸŒ•",s:200,v:90,n:"å¤§æœˆçƒ"}] },
            { name: "æ°£é«”å·¨æ˜Ÿ", min: 2500, grid: 1800, objs: [{t:"ğŸ”µ",s:700,v:300,n:"æµ·ç‹æ˜Ÿ",g:true}, {t:"ğŸ’ ",s:750,v:350,n:"å¤©ç‹æ˜Ÿ",g:true}, {t:"ğŸª",s:1000,v:500,n:"åœŸæ˜Ÿ",g:true}, {t:"ğŸŸ ",s:1300,v:800,n:"æœ¨æ˜Ÿ",g:true}, {t:"ğŸŸ£",s:600,v:250,n:"å†¥ç‹æ˜Ÿ"}] },
            { name: "æ†æ˜Ÿç´š", min: 8000, grid: 5000, objs: [{t:"ğŸŒŒ",s:2200,v:1000,n:"æ˜Ÿé›²"}, {t:"ğŸ•³ï¸",s:2800,v:1200,n:"é»‘æ´"}, {t:"ğŸ’«",s:2000,v:900,n:"è„ˆè¡æ˜Ÿ"}, {t:"â­",s:1800,v:800,n:"å·¨æ˜Ÿ"}, {t:"ğŸŒ€",s:2500,v:1100,n:"æ˜Ÿç³»"}] }
        ];

        let currentDiff = 'easy';
        let currentLevel = 1;
        let STAGES = [];
        let player = { x: 0, y: 0, size: 20, angle: 0, vx: 0, vy: 0, invulnerable: 0 };
        let knockback = { x: 0, y: 0 }; 
        let cameraScale = 1;
        let foods = [], particles = [], floatTexts = [], gravParticles = [];
        let boss = null;
        let mouse = { x: 0, y: 0, active: false };
        let shake = 0, stars = [];
        let timeLeft = 0, lastTime = 0, isGameOver = false;
        let lastSecond = 0;
        let winSize = 0;
        let canvas, ctx, width, height, animId;
        let audioCtx = null;

        // =============================================
        // 2. å…¨åŸŸå‡½å¼
        // =============================================

        window.setDiff = function(diff) {
            currentDiff = diff;
            ['easy', 'hard', 'nightmare'].forEach(d => {
                const btn = document.getElementById(`btn-diff-${d}`);
                if (d === diff) {
                    btn.classList.add('active');
                    btn.style.boxShadow = `0 4px 0 rgba(0,0,0,0.2)`;
                } else {
                    btn.classList.remove('active');
                    btn.style.boxShadow = 'none';
                }
            });
            document.getElementById('diff-desc').innerHTML = DIFFICULTY[diff].desc.replace('\n', '<br>');
            
            // æ›´æ–°ç¬¬äºŒé—œä»‹ç´¹çš„æ™‚é–“
            document.getElementById('l2-time-display').innerText = DIFFICULTY[diff].timeL2;
        };

        window.startLevel = function(level) {
            document.querySelectorAll('.overlay-screen').forEach(el => el.classList.add('hidden'));
            document.getElementById('game-container').style.display = 'block';
            document.getElementById('flash-overlay').style.opacity = 0;
            
            const diffLabel = document.getElementById('diff-label');
            if(diffLabel) {
                diffLabel.innerText = DIFFICULTY[currentDiff].name;
                diffLabel.style.backgroundColor = DIFFICULTY[currentDiff].color;
            }

            try { initAudio(); initGame(level); } catch(e) { console.error(e); }
        };

        window.goToSpace = function() {
            document.getElementById('level-clear-screen').classList.add('hidden');
            document.getElementById('level2-intro-screen').classList.remove('hidden');
        };

        window.retryLevel = function() {
            window.startLevel(currentLevel);
        };

        // â˜…â˜…â˜… å¼·åˆ¶é‡æ–°æ•´ç†é é¢ï¼Œç¢ºä¿å›åˆ°é¦–é æŒ‰éˆ•æœ‰æ•ˆ â˜…â˜…â˜…
        window.goHome = function() {
            window.location.reload(); 
        };

        // =============================================
        // 3. éŠæˆ²é‚è¼¯èˆ‡åˆå§‹åŒ–
        // =============================================

        function initAudio() {
            const AC = window.AudioContext || window.webkitAudioContext;
            if (AC && !audioCtx) { audioCtx = new AC(); audioCtx.resume(); }
        }

        function playSound(type) {
            if (!audioCtx) return;
            try {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                const now = audioCtx.currentTime;

                if (type === 'eat') {
                    osc.frequency.setValueAtTime(300 + Math.random()*200, now);
                    osc.frequency.exponentialRampToValueAtTime(100, now + 0.1);
                    gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now + 0.1);
                } else if (type === 'bonk') { 
                    osc.type = 'sawtooth';
                    osc.frequency.setValueAtTime(150, now); osc.frequency.exponentialRampToValueAtTime(50, now + 0.2);
                    gain.gain.setValueAtTime(0.2, now); gain.gain.linearRampToValueAtTime(0, now + 0.2);
                } else if (type === 'gravity') { 
                    osc.type = 'sine'; osc.frequency.setValueAtTime(50, now);
                    gain.gain.setValueAtTime(0.08, now); gain.gain.linearRampToValueAtTime(0, now + 0.5);
                } else if (type === 'win') {
                    [523, 659, 783, 1046].forEach((f, i) => {
                        const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
                        o.frequency.value = f; g.gain.setValueAtTime(0.1, now+i*0.1); g.gain.exponentialRampToValueAtTime(0.001, now+i*0.1+0.5);
                        o.connect(g); g.connect(audioCtx.destination); o.start(now+i*0.1); o.stop(now+i*0.1+0.5);
                    });
                    return;
                } else if (type === 'alarm') { 
                     osc.type = 'square'; osc.frequency.setValueAtTime(800, now);
                     gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now+0.1);
                } else if (type === 'final') { 
                    osc.type = 'triangle';
                    osc.frequency.setValueAtTime(100, now); osc.frequency.linearRampToValueAtTime(880, now + 3);
                    gain.gain.setValueAtTime(0.2, now); gain.gain.linearRampToValueAtTime(0, now + 3);
                }

                osc.connect(gain); gain.connect(audioCtx.destination);
                osc.start(); osc.stop(now + 0.5);
            } catch(e) {}
        }

        function initGame(level) {
            if (animId) cancelAnimationFrame(animId);
            canvas = document.getElementById('gameCanvas');
            ctx = canvas.getContext('2d', { alpha: false });
            currentLevel = level;
            STAGES = level === 1 ? LEVEL_1_DATA : LEVEL_2_DATA;
            
            const config = DIFFICULTY[currentDiff];

            let startSize = level === 1 ? 20 : 60; 
            player = { x: 0, y: 0, size: startSize, angle: 0, vx: 0, vy: 0, invulnerable: 0 };
            foods = []; particles = []; floatTexts = []; gravParticles = []; boss = null;
            
            timeLeft = level === 1 ? config.timeL1 : config.timeL2;
            winSize = level === 1 ? 5000 : 15000;
            
            isGameOver = false; lastTime = Date.now(); shake = 0;

            if (level === 2) {
                document.body.style.backgroundColor = "#0b0b15";
                document.getElementById('ui-timer').style.color = "#a29bfe";
                document.getElementById('timer-box').style.borderColor = "#a29bfe";
                initStars();
            } else {
                document.body.style.backgroundColor = "#fdfdf5";
                document.getElementById('ui-timer').style.color = "#ff6b6b";
                document.getElementById('timer-box').style.borderColor = "#ff6b6b";
            }
            document.getElementById('timer-box').classList.remove('timer-emergency');
            document.getElementById('timer-box').style.display = 'flex';

            resize();
            window.addEventListener('resize', resize);
            bindInput();
            spawnFood(150);
            loop();
        }

        function resize() {
            width = window.innerWidth; height = window.innerHeight;
            canvas.width = width; canvas.height = height;
            if(!mouse.active) { mouse.x = width/2; mouse.y = height/2; }
            if(currentLevel === 2) initStars();
        }

        function initStars() {
            stars = [];
            for(let i=0; i<300; i++) stars.push({x:Math.random()*width, y:Math.random()*height, size:Math.random()*2, alpha:Math.random()});
        }

        function bindInput() {
            const handleMove = (x, y) => { mouse.x = x; mouse.y = y; mouse.active = true; };
            document.addEventListener('mousemove', e => handleMove(e.clientX, e.clientY));
            document.addEventListener('touchmove', e => { e.preventDefault(); handleMove(e.touches[0].clientX, e.touches[0].clientY); }, {passive:false});
            document.addEventListener('touchstart', e => { e.preventDefault(); handleMove(e.touches[0].clientX, e.touches[0].clientY); }, {passive:false});
            document.addEventListener('touchend', () => mouse.active = false);
        }

        function loop() {
            if (isGameOver) return;
            let now = Date.now();
            let dt = (now - lastTime) / 1000;
            lastTime = now;
            update(dt);
            draw();
            animId = requestAnimationFrame(loop);
        }

        function update(dt) {
            if (player.invulnerable > 0) player.invulnerable -= dt;

            // æ™‚é–“å€’æ•¸
            if (!boss) {
                timeLeft -= dt;
                if (timeLeft < 15 && Math.floor(timeLeft) < lastSecond) {
                    playSound('alarm');
                    document.getElementById('timer-box').classList.add('timer-emergency');
                }
                lastSecond = Math.floor(timeLeft);
                if (timeLeft <= 0) { timeLeft = 0; showGameOver("æ™‚é–“è€—ç›¡"); return; }
            }

            // ç§»å‹•
            let targetVx = 0, targetVy = 0;
            if (mouse.active) {
                let mx = mouse.x - width/2, my = mouse.y - height/2;
                let angle = Math.atan2(my, mx);
                let diff = angle - player.angle;
                while (diff > Math.PI) diff -= Math.PI*2; while (diff < -Math.PI) diff += Math.PI*2;
                player.angle += diff * 0.15;

                let dist = Math.hypot(mx, my);
                let baseSpeed = (15 / cameraScale) * Math.min(dist / 100, 1);
                targetVx = Math.cos(player.angle) * baseSpeed;
                targetVy = Math.sin(player.angle) * baseSpeed;
            } else {
                targetVx = Math.cos(player.angle) * (2/cameraScale);
                targetVy = Math.sin(player.angle) * (2/cameraScale);
            }
            player.vx += (targetVx - player.vx) * 0.1;
            player.vy += (targetVy - player.vy) * 0.1;

            if (currentLevel === 2) {
                foods.forEach(f => { if (f.g) applyGravity(f, f.s * 5, f.s * 10); });
                if (boss) applyGravity(boss, 20000, 20000); 
            }

            player.x += player.vx + knockback.x;
            player.y += player.vy + knockback.y;
            knockback.x *= 0.9; knockback.y *= 0.9;

            let targetScale = 30 / player.size;
            if (boss) targetScale = 15 / player.size;
            cameraScale += (targetScale - cameraScale) * 0.05;

            if (foods.length < 150) spawnFood(1);
            
            let bossThreshold = currentLevel === 1 ? 4000 : 12000;
            if (player.size > bossThreshold && !boss) spawnBoss();

            checkCollisions();
            if (shake > 0) shake *= 0.9;
            updateUI();
        }

        function applyGravity(target, range, strength) {
            let dx = target.x - player.x;
            let dy = target.y - player.y;
            let dist = Math.hypot(dx, dy);
            if (dist < range) {
                let force = (1 - dist / range) * (strength / player.size) * 1.5; 
                player.vx += (dx / dist) * force;
                player.vy += (dy / dist) * force;
                if (Math.random() < 0.1) {
                    gravParticles.push({
                        x: player.x + (Math.random()-0.5)*range, y: player.y + (Math.random()-0.5)*range,
                        tx: target.x, ty: target.y, life: 1.0
                    });
                }
                if(dist < range * 0.2 && Math.random() < 0.05) playSound('gravity');
            }
        }

        function spawnFood(count) {
            let sIdx = STAGES.findIndex(s => player.size < s.min * 2.5);
            if (sIdx === -1) sIdx = STAGES.length - 1;
            
            let pool = [];
            let dangerRate = DIFFICULTY[currentDiff].dangerProb;
            
            if (Math.random() > dangerRate) {
                pool = [...STAGES[sIdx].objs];
                if (sIdx > 0) pool = pool.concat(STAGES[sIdx-1].objs);
            } else if (sIdx < STAGES.length - 1) {
                pool = [...STAGES[sIdx+1].objs];
            } else {
                pool = [...STAGES[sIdx].objs];
            }
            
            if (pool.length === 0) pool = [...STAGES[0].objs];

            for(let i=0; i<count; i++) {
                let obj = pool[Math.floor(Math.random()*pool.length)];
                let angle = Math.random()*Math.PI*2;
                let minD = Math.max(width, height)/cameraScale*0.6;
                let dist = minD + Math.random()*minD;
                foods.push({ x: player.x+Math.cos(angle)*dist, y: player.y+Math.sin(angle)*dist, t:obj.t, s:obj.s, v:obj.v, n:obj.n, g:obj.g });
            }
        }

        function spawnBoss() {
            let dist = 15000;
            if (currentLevel === 1) {
                boss = { x: player.x + dist, y: player.y, size: 5000, t: "ğŸŒ", name: "åœ°çƒ" };
            } else {
                boss = { x: player.x + dist, y: player.y, size: 15000, t: "â˜€ï¸", name: "å¤ªé™½" };
            }
            document.getElementById('ui-hint').innerText = `BOSSï¼š${boss.name} å‡ºç¾ï¼`;
            document.getElementById('ui-hint').style.color = "#d15e5e";
            document.getElementById('timer-box').style.display = 'none'; 
        }

        function checkCollisions() {
            const config = DIFFICULTY[currentDiff];

            for (let i = foods.length - 1; i >= 0; i--) {
                let f = foods[i];
                if (Math.abs(f.x - player.x) > (width/cameraScale)*3) { foods.splice(i, 1); continue; }
                let d = Math.hypot(player.x - f.x, player.y - f.y);
                
                let touchDist = (player.size + f.s) * 0.95;
                if (d < touchDist) {
                    if (player.size >= f.s) {
                        player.size += f.v * config.growthRate;
                        playSound('eat'); createParticles(f.x, f.y, f.t, f.s); foods.splice(i, 1);
                    } else {
                        if (player.invulnerable <= 0) {
                            player.size = Math.max(currentLevel===1?20:60, player.size * config.penalty);
                            player.invulnerable = 1.0;
                            applyKnockback(f); playSound('bonk'); flashDamage();
                            addFloatText(player.x, player.y-50, `-${Math.round((1-config.penalty)*100)}%`, "#ff4757");
                        }
                    }
                }
            }

            if (boss) {
                let d = Math.hypot(player.x - boss.x, player.y - boss.y);
                
                let isTouching = d < (player.size + boss.size) * config.bossHitBox;
                
                if (isTouching) {
                    if (player.size >= winSize) {
                        shake = 50; 
                        if(currentLevel === 1) level1Clear(); else finalVictory();
                    } else {
                        if(player.invulnerable <= 0) {
                            player.size *= config.penalty; 
                            player.invulnerable = 1.0;
                            applyKnockback(boss, 80); playSound('bonk'); flashDamage();
                            addFloatText(player.x, player.y, `é‚„å¤ªå°! éœ€${Math.floor(winSize/20)}m`, "#ff6b6b");
                        }
                    }
                }
            }
        }

        function applyKnockback(target, forceVal = 40) {
            let angle = Math.atan2(player.y - target.y, player.x - target.x);
            let force = forceVal / cameraScale;
            knockback.x = Math.cos(angle) * force; knockback.y = Math.sin(angle) * force;
            shake = 15;
            player.vx = Math.cos(angle) * force * 0.8; player.vy = Math.sin(angle) * force * 0.8;
        }

        function flashDamage() {
            const el = document.getElementById('damage-overlay');
            el.style.opacity = 1; setTimeout(() => el.style.opacity = 0, 100);
        }

        function addFloatText(x, y, text, color="#fff") {
            floatTexts.push({x, y, text, color, life: 1.0});
        }

        function createParticles(x, y, char, size) {
            for(let i=0; i<4; i++) particles.push({x:x, y:y, vx:(Math.random()-0.5)*size, vy:(Math.random()-0.5)*size, life:1.0, char:char, size:size*0.6});
        }

        function updateUI() {
            if (!isGameOver) {
                let mins = Math.floor(timeLeft/60); let secs = Math.floor(timeLeft%60);
                document.getElementById('ui-timer').innerText = `${mins}:${secs.toString().padStart(2,'0')}`;
            }

            let sIdx = 0; 
            for(let i=0; i<STAGES.length; i++) {
                if (player.size >= STAGES[i].min) sIdx = i; else break;
            }
            
            document.getElementById('ui-stage').innerText = STAGES[sIdx].name;
            if(!boss) {
                let items = STAGES[sIdx].objs.map(o => o.t).join(" ");
                document.getElementById('ui-hint').innerText = `ç›®æ¨™ï¼š${items}`;
            }
            document.getElementById('ui-size').innerText = (player.size/20).toFixed(1) + "m";
            
            let targetSize = boss ? winSize : STAGES[sIdx+1]?.min || winSize;
            let pct = Math.min((player.size / targetSize) * 100, 100);
            document.getElementById('ui-bar').style.width = pct + "%";
        }

        function level1Clear() {
            isGameOver = true; playSound('win');
            document.getElementById('game-container').style.display = 'none';
            document.getElementById('level-clear-screen').classList.remove('hidden');
        }

        function showGameOver(reason) {
            isGameOver = true;
            document.getElementById('game-container').style.display = 'none';
            document.getElementById('fail-reason').innerText = reason;
            document.getElementById('game-over-screen').classList.remove('hidden');
        }

        function finalVictory() {
            if(isGameOver) return;
            isGameOver = true;
            playSound('final');
            const flash = document.getElementById('flash-overlay');
            flash.style.opacity = 1;
            setTimeout(() => {
                document.getElementById('game-container').style.display = 'none';
                document.getElementById('victory-screen').classList.remove('hidden');
            }, 3000);
        }

        function draw() {
            let sx = (Math.random()-0.5)*shake, sy = (Math.random()-0.5)*shake;

            if (currentLevel === 2) {
                ctx.fillStyle = "#0b0b15"; ctx.fillRect(0,0,width,height);
                ctx.fillStyle = "white";
                stars.forEach(s => {
                    let x = (s.x - player.x * 0.1) % width; let y = (s.y - player.y * 0.1) % height;
                    if(x<0) x+=width; if(y<0) y+=height;
                    ctx.globalAlpha = s.alpha * (0.5 + Math.sin(Date.now()*0.005)*0.5);
                    ctx.beginPath(); ctx.arc(x,y,s.size,0,Math.PI*2); ctx.fill();
                });
                ctx.globalAlpha = 1;
            } else {
                ctx.fillStyle = "#fdfdf5"; ctx.fillRect(0,0,width,height);
            }

            ctx.save();
            ctx.translate(width/2 + sx, height/2 + sy);
            ctx.scale(cameraScale, cameraScale);
            ctx.translate(-player.x, -player.y);

            if(currentLevel === 1) drawGrid();

            if(currentLevel === 2) {
                foods.forEach(f => { if(f.g) drawGravityWave(f.x, f.y, f.s * 2, false); });
                if(boss) drawGravityWave(boss.x, boss.y, boss.size * 1.5, true);
                
                ctx.strokeStyle = "rgba(100, 200, 255, 0.5)"; ctx.lineWidth = 2 / cameraScale;
                for(let i=gravParticles.length-1; i>=0; i--) {
                    let p = gravParticles[i]; p.life -= 0.02;
                    let dx = p.tx - p.x; let dy = p.ty - p.y;
                    p.x += dx * 0.05; p.y += dy * 0.05;
                    ctx.globalAlpha = p.life;
                    ctx.beginPath(); ctx.moveTo(p.x - dx*0.05, p.y - dy*0.05); ctx.lineTo(p.x, p.y); ctx.stroke();
                    if(p.life<=0) gravParticles.splice(i,1);
                }
                ctx.globalAlpha = 1;
            }

            ctx.textAlign = "center"; ctx.textBaseline = "middle";
            foods.forEach(f => {
                let fontSize = f.s * 2.2;
                ctx.font = `bold ${fontSize}px Arial`;
                if(currentLevel === 2) { ctx.shadowColor = "white"; ctx.shadowBlur = 10; }
                ctx.fillStyle = "black"; ctx.fillText(f.t, f.x, f.y);
                ctx.shadowBlur = 0;
                if (f.n && player.size > f.s * 0.3) {
                    ctx.font = `bold ${f.s * 0.6}px 'Varela Round', Arial`;
                    ctx.fillStyle = currentLevel === 2 ? "white" : "#555";
                    ctx.shadowColor = "black"; ctx.shadowBlur = 4;
                    ctx.fillText(f.n, f.x, f.y + f.s * 1.5);
                    ctx.shadowBlur = 0;
                }
            });

            if (boss) {
                if (currentLevel === 1) {
                    ctx.fillStyle = "rgba(100,200,255,0.2)"; ctx.beginPath(); ctx.arc(boss.x, boss.y, boss.size*1.2, 0, Math.PI*2); ctx.fill();
                    ctx.font = `${boss.size * 2}px Arial`; ctx.fillText(boss.t, boss.x, boss.y);
                } else {
                    let glow = 200 + Math.sin(Date.now()*0.01)*100;
                    ctx.shadowBlur = glow; ctx.shadowColor = "#ffaa00";
                    ctx.fillStyle = "#ffaa00"; ctx.beginPath(); ctx.arc(boss.x, boss.y, boss.size, 0, Math.PI*2); ctx.fill();
                    ctx.shadowBlur = 0; ctx.font = `${boss.size * 1.5}px Arial`; ctx.fillText("â˜€ï¸", boss.x, boss.y);
                }
            }

            for(let i=particles.length-1; i>=0; i--) {
                let p = particles[i]; p.x += p.vx; p.y += p.vy; p.life -= 0.05;
                ctx.globalAlpha = p.life; ctx.font = `${p.size}px Arial`; ctx.fillText(p.char, p.x, p.y);
                ctx.globalAlpha = 1; if(p.life<=0) particles.splice(i,1);
            }
            for(let i=floatTexts.length-1; i>=0; i--) {
                let ft = floatTexts[i]; ft.life -= 0.02; ft.y -= 2/cameraScale;
                ctx.globalAlpha = ft.life; ctx.fillStyle = ft.color;
                ctx.font = `bold ${40/cameraScale}px Arial`; ctx.fillText(ft.text, ft.x, ft.y);
                ctx.globalAlpha = 1; if(ft.life<=0) floatTexts.splice(i,1);
            }

            drawBee();
            ctx.restore();

            if (boss) drawRadar();
        }

        function drawRadar() {
            let dx = boss.x - player.x; let dy = boss.y - player.y;
            let angle = Math.atan2(dy, dx); let dist = Math.sqrt(dx*dx + dy*dy);
            let radarR = Math.min(width, height) * 0.4; 
            let px = width/2 + Math.cos(angle) * radarR; let py = height/2 + Math.sin(angle) * radarR;

            ctx.save(); ctx.translate(px, py);
            ctx.fillStyle = "rgba(255, 107, 107, 0.9)"; ctx.beginPath(); ctx.arc(0, 0, 45, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = "white"; ctx.beginPath(); ctx.arc(0, 0, 40, 0, Math.PI*2); ctx.fill();
            ctx.rotate(angle);
            ctx.fillStyle = "#ff6b6b"; ctx.beginPath(); ctx.moveTo(15, 0); ctx.lineTo(-10, 10); ctx.lineTo(-10, -10); ctx.fill();
            ctx.rotate(-angle); 
            ctx.fillStyle = "#ff6b6b"; ctx.font = "bold 14px Arial"; ctx.textAlign = "center"; ctx.textBaseline = "middle";
            let distText = Math.floor(dist/100) + "m";
            ctx.fillText(distText, 0, 20); ctx.font = "bold 12px Arial"; ctx.fillText("BOSS", 0, -20); 
            ctx.restore();
        }

        function drawGravityWave(x, y, radius, isSun) {
            let time = Date.now() * 0.001; let count = isSun ? 6 : 3;
            ctx.strokeStyle = isSun ? "rgba(255, 160, 0, 0.4)" : "rgba(100, 200, 255, 0.3)";
            ctx.lineWidth = 10 / cameraScale;
            for(let i=0; i<count; i++) {
                let r = (time + i/count) % 1; let drawR = radius * (1.5 - r * 0.5); 
                ctx.globalAlpha = r * 0.5; ctx.beginPath(); ctx.arc(x, y, drawR, 0, Math.PI*2); ctx.stroke();
            }
            ctx.globalAlpha = 1;
        }

        function drawGrid() {
            let sIdx = 0; for(let i=0; i<STAGES.length; i++) if(player.size>=STAGES[i].min) sIdx=i;
            let gridSize = STAGES[sIdx].grid;
            let range = width/cameraScale;
            let startX = Math.floor((player.x-range)/gridSize)*gridSize; let endX = Math.floor((player.x+range)/gridSize)*gridSize;
            let startY = Math.floor((player.y-height/cameraScale)/gridSize)*gridSize; let endY = Math.floor((player.y+height/cameraScale)/gridSize)*gridSize;
            ctx.fillStyle = "#e0f0e0";
            for(let x=startX; x<=endX; x+=gridSize) for(let y=startY; y<=endY; y+=gridSize) {
                ctx.beginPath(); ctx.arc(x,y, 6/cameraScale+player.size*0.02, 0, Math.PI*2); ctx.fill();
            }
        }

        function drawBee() {
            ctx.save(); ctx.translate(player.x, player.y); ctx.rotate(player.angle);
            let r = player.size;
            if(shake > 0) ctx.rotate(Math.sin(Date.now()*0.5)*0.2);
            if (player.invulnerable > 0) { if (Math.floor(Date.now() / 100) % 2 === 0) ctx.globalAlpha = 0.5; }

            ctx.fillStyle = "#ffcc00"; ctx.beginPath(); ctx.ellipse(0,0, r*1.2, r*0.9, 0,0,Math.PI*2); ctx.fill();
            ctx.lineWidth = r*0.08; ctx.strokeStyle = "#5c5043"; ctx.stroke();
            ctx.fillStyle = "#5c5043"; ctx.beginPath(); ctx.fillRect(-r*0.2, -r*0.8, r*0.3, r*1.6); ctx.beginPath(); ctx.fillRect(r*0.4, -r*0.7, r*0.3, r*1.4);
            let w = Math.sin(Date.now()*0.05)*0.2;
            ctx.fillStyle = "rgba(255,255,255,0.85)"; ctx.beginPath(); ctx.ellipse(0, -r*0.8, r*0.6, r*0.4+w*r, 0,0,Math.PI*2); ctx.fill(); ctx.stroke();
            ctx.beginPath(); ctx.ellipse(0, r*0.8, r*0.6, r*0.4+w*r, 0,0,Math.PI*2); ctx.fill(); ctx.stroke();
            ctx.fillStyle = "white"; ctx.beginPath(); ctx.arc(r*0.7, -r*0.3, r*0.3, 0,Math.PI*2); ctx.fill();
            ctx.fillStyle = "black"; ctx.beginPath(); ctx.arc(r*0.8, -r*0.3, r*0.12, 0,Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.moveTo(-r*1.2, 0); ctx.lineTo(-r*1.5, 0); ctx.stroke();

            if (currentLevel === 2) {
                ctx.fillStyle = "rgba(200, 240, 255, 0.3)"; ctx.strokeStyle = "rgba(255, 255, 255, 0.6)"; ctx.lineWidth = r * 0.05;
                ctx.beginPath(); ctx.arc(r*0.2, 0, r*1.1, 0, Math.PI*2); ctx.fill(); ctx.stroke();
                ctx.fillStyle = "rgba(255, 255, 255, 0.6)"; ctx.beginPath(); ctx.ellipse(r*0.5, -r*0.5, r*0.2, r*0.1, -Math.PI/4, 0, Math.PI*2); ctx.fill();
            }
            
            ctx.globalAlpha = 1;
            ctx.restore();
        }
    </script>
</body>
</html>


